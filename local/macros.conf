[datamodel]
definition = Web
iseval = 0

[addTimeCompareWindow]
definition = addinfo\
| eval info_max_time=if(info_max_time="+Infinity", info_search_time, info_max_time)\
| eval window=coalesce(info_max_time-info_min_time,now())\
| eval windowLength=case(window<7200, "1h",window<28800, "4h",window<90000, "24h",window<=86400*7, "24h",window>86400*7 and window<=86400*8, "1w",window<90000*31, "1mon", 1=1, "1y") \
| eval earliestCompare= case(ImmediatePeriodCompare=1 AND info_max_time!="+Infinity", max(info_min_time-window,0), ImmediatePeriodCompare!=1 AND windowLength="1h", relative_time(info_min_time,"-1h"), ImmediatePeriodCompare!=1 AND windowLength="4h", relative_time(info_min_time,"-1d"), ImmediatePeriodCompare!=1 AND windowLength="24h", relative_time(info_min_time,"-7d"), ImmediatePeriodCompare!=1 AND windowLength="1w", relative_time(info_min_time,"-4w"), ImmediatePeriodCompare!=1 AND windowLength="1mon", relative_time(info_min_time,"-12mon"),windowLength="1y",relative_time(info_max_time,"-2y")) \
| eval latestCompare= case( ImmediatePeriodCompare=1 AND info_max_time!="+Infinity", info_min_time, ImmediatePeriodCompare!=1 AND windowLength="1h", relative_time(info_max_time,"-1d"), ImmediatePeriodCompare!=1 AND windowLength="4h", relative_time(info_max_time,"-1d"), ImmediatePeriodCompare!=1 AND windowLength="24h", relative_time(info_max_time,"-7d"), ImmediatePeriodCompare!=1 AND windowLength="1w", relative_time(info_max_time,"-4w"), ImmediatePeriodCompare!=1 AND windowLength="1mon", relative_time(info_max_time,"-12mon"),windowLength="1y",relative_time(info_max_time,"-1y")) \
\
| eval ComparePeriodDescription= \
case( \
ImmediatePeriodCompare=1 AND windowLength="1h", "Compared to last hour", \
ImmediatePeriodCompare=1 AND windowLength="4h", "Compared to last 4 hours", \
ImmediatePeriodCompare=1 AND windowLength="24h", "Compared to yesterday", \
ImmediatePeriodCompare=1 AND windowLength="1w",  "Compared to last week", \
ImmediatePeriodCompare=1 AND windowLength="1mon",  "Compared to last month", \
ImmediatePeriodCompare=1 AND windowLength="1y",  "Compared to last year", \
ImmediatePeriodCompare!=1 AND windowLength="1h", "Compared to same hour yesterday", \
ImmediatePeriodCompare!=1 AND windowLength="4h", "Compared to same 4 hours yesterday", \
ImmediatePeriodCompare!=1 AND windowLength="24h",  "Compared to same day last week", \
ImmediatePeriodCompare!=1 AND windowLength="1w",  "Compared to same week 4 weeks ago", \
ImmediatePeriodCompare!=1 AND windowLength="1mon",  "Compared to same month last year",\
ImmediatePeriodCompare!=1 AND windowLength="1y",  "Compared to same month last year"\
)\
| eval FieldnameCurrentPeriod=case(\
    windowLength="1h","Count_latest_hour",\
    windowLength="4h","Count_latest_4hours",\
    windowLength="24h","Count_latest_24hours",\
    windowLength="7d","Count_latest_week",\
windowLength="1w","Count_latest_week",\
    windowLength="30d","Count_latest_month",\
1=1, "Count_latest*"\
) \
| eval FieldnameComparePeriod=case(\
    windowLength="1h" AND ImmediatePeriodCompare=0,"Count_24hours_before",\
    windowLength="1h" AND ImmediatePeriodCompare=1,"Count_1hour_before",\
    windowLength="4h" AND ImmediatePeriodCompare=0,"Count_24hours_before",\
    windowLength="4h" AND ImmediatePeriodCompare=1,"Count_4hours_before",\
    windowLength="24h" AND ImmediatePeriodCompare=0,"Count_168hours_before",\
    windowLength="24h" AND ImmediatePeriodCompare=1,"Count_24hours_before",\
    windowLength="1w" AND ImmediatePeriodCompare=0,"Count_4weeks_before",\
    windowLength="1w" AND ImmediatePeriodCompare=1,"Count_1week_before",\
    windowLength="30d" AND ImmediatePeriodCompare=0,"Count_360days_before",\
    windowLength="30d" AND ImmediatePeriodCompare=1,"Count_30days_before",\
    windowLength="1mon" AND ImmediatePeriodCompare=0,"Count_12months_before",\
    windowLength="1mon" AND ImmediatePeriodCompare=1,"Count_1month_before",\
    ImmediatePeriodCompare=0,"Count*_before",\
    ImmediatePeriodCompare=1,"Count*_before"\
    )
