<form script="dashboards.js" stylesheet="dashboard.css">
  <label>Websites</label>
  <description>Websites are configured from a combination of the host and the source field. Each event with that unique combination will be tagged with the corresponding website name in the field "site". The "site" fields should match your domain name, i.e. "www.mydomain.com".  Click the tables below to prefill the setup form. You can use wildcards (*) in the Source field to select multiple files matching a pattern. The data in the setup form will be stored in the lookup file called WA_settings.csv. You can also edit this file manually.</description>
  <search id="createlookup_settings">
    <query>| outputlookup WA_settings.csv createinapp=t append=t</query>
  </search>
  <fieldset submitButton="false"></fieldset>
  <row>
    <panel>
      <title>1. Available host and source combinations (Click to fill setup form)</title>
      <input type="time" token="field1">
        <label></label>
        <default>
          <earliest>-30d@d</earliest>
          <latest>now</latest>
        </default>
      </input>
      <input type="text" token="filter" searchWhenChanged="true">
        <label>Filter</label>
        <default>*</default>
      </input>
      <html>
      	<p class="table_description">Verify that all applicable host and source combinations has a green checkmark in the "Configured" column.</p>
      </html>
      <table id="available_sources_table" depends="$filter$">
        <search>
          <query>| metasearch
    [ rest /services/properties/eventtypes/web-traffic/search splunk_server=local
    | eval search=value]
| join type=outer sourcetype
    [ search
        [| metadata type=sourcetypes
        | search sourcetype="aws:cloudfront:accesslogs" OR sourcetype="iis" OR sourcetype=apache:access OR sourcetype=aws:cloudfront:accesslogs OR sourcetype="access_combined" OR sourcetype="access_common" OR sourcetype="access_combined_wcookie"
        | eval latest=lastTime, earliest=latest-180
        | fields latest earliest sourcetype
        | eval search="(sourcetype="+sourcetype+" latest="+latest+" earliest="+earliest+")"
        | stats list(search) as search
        | eval search=mvjoin('search'," OR ")
        | fields search ]
    | stats first(site) AS site by host, sourcetype,source
    | rename host as host2, source AS source2
    | fields sourcetype host2 site source2]
| eval host=if(isnotnull(host2) AND source=source2, host2, host)
| stats count AS events,first(site) AS site by host, source
| search host=*** OR source=***
| lookup WA_settings source AS source host AS host OUTPUTNEW value AS site
| eval Configured=site
| fields host source Configured site events</query>
          <earliest>$field1.earliest$</earliest>
          <latest>$field1.latest$</latest>
        </search>
        <option name="count">5</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">row</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <option name="wrap">true</option>
        <drilldown>
          <set token="form.value"></set>
          <set token="form.host">$row.host$</set>
          <set token="form.source">$row.source$</set>
        </drilldown>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>2. Setup new website</title>
      <input type="text" token="value" searchWhenChanged="true">
        <label>Site (www.mydomain.com)</label>
      </input>
      <input type="text" token="host">
        <label>Host (Accepts wildcard *)</label>
      </input>
      <input type="text" token="source" searchWhenChanged="true" id="setup_source">
        <label>Source (Accepts wildcard *)</label>
      </input>
      <html>
		<button class="btn" data-set-token="save_site" data-value="show">Save website</button>
	</html>
      <single depends="$save_site$">
        <search>
          <query>|inputlookup WA_settings.csv | search (host!="$host$" OR source!="$source$") | append [search | stats count | eval key="site"| eval value="$value$"| eval host="$host$" | eval source="$source$"] | fields key value source host | sort key value | outputlookup WA_settings.csv createinapp=t | eval Response="Site was succesfully saved." | head 1 | fields Response</query>
          <earliest>0</earliest>
          <latest></latest>
        </search>
        <option name="wrap">undefined</option>
        <option name="rowNumbers">true</option>
        <option name="drilldown">none</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>3. Configured websites (Click to fill setup form)</title>
      <table>
        <search>
          <query>| inputlookup WA_settings.csv | search key=site | fields value host source | rename value AS Site, host AS Host, source as Source</query>
          <earliest>0</earliest>
          <latest></latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
        <option name="drilldown">row</option>
        <drilldown>
          <set token="form.value">$row.Site$</set>
          <set token="form.host">$row.Host$</set>
          <set token="form.source">$row.Source$</set>
        </drilldown>
        <option name="dataOverlayMode">none</option>
        <option name="count">5</option>
      </table>
    </panel>
  </row>
</form>
